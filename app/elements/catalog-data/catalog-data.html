<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<dom-module id="catalog-data">
  <template>
    <core-ajax id="req" url="/catalog.json" method="get" handle-as="json" on-response="handleResponse">
  </template>
</dom-module>

<script>
  (function() {
    var _data = {};
    var _els = [];

    var _setData = function(data) {
      _data = data;
      _els.forEach(function(el){ el.load(_data) });
    }

    Polymer({
      is: 'catalog-data',
      created: function() {
        this.load(_data)
      },
      attached: function() {
        if (_els.length === 0) { this.$.req.generateRequest(); }
        _els.push(this);
      },
      detached: function() {
        _els.splice(_els.indexOf(this), 1);
      },
      properties: {
        packages: {
          type: Array,
          readOnly: true,
          notify: true
        },
        packageMap: {
          type: Object,
          readOnly: true,
          notify: true
        },
        elements: {
          type: Object,
          readOnly: true,
          notify: true
        },
        elementMap: {
          type: Object,
          readOnly: true,
          notify: true
        },
        tags: {
          type: Object,
          readOnly: true,
          notify: true
        }
      },
      load: function(data) {
        if (data.packages) {
          this._setPackages(data.packages);
          this._setPackageMap(this._generateMap(data.packages));
          this._setElements(data.elements);
          this._setElementMap(this._generateMap(data.elements));
          this._setTags(data.tags);
        }
      },
      handleResponse: function(_, data) {
        this.load(data);
      },
      _generateMap: function(list) {
        var out = {};
        for (var i = 0; i < list.length; i++) {
          out[list[i].name] = list[i];
        }
        return out;
      }
    })
  })();
</script>