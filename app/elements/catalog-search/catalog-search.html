<link rel="import" href="../catalog-data/catalog-data.html">

<dom-module id="catalog-search">
  <style>
    :host {
      z-index: 1000;
      width: 240px;
      display: block;
      position: absolute;
      top: 0;
      right: 0;
      height: 100vh;
      background: white;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
      will-change: transform;
      transition: transform 0.15s;
      transform: translateX(240px);
    }

    :host([active]) {
      transform: translateX(0);
    }

    #q {
      font-family: RobotoDraft, sans-serif;
      font-size: 16px;
      padding: 8px 12px;
      border: 0;
    }

    h3 {
      text-transform: uppercase;
      font-size: 14px;
      padding-bottom: 4px;
      border-bottom: 1px solid #eee;
    }

    .result h4 {
      font-size: 14px;
      margin: 8px 0 4px;
    }

    .result p {
      font-size: 12px;
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 16px;
      height: 32px;
    }

    #results {
      padding: 12px;
      overflow-y: auto;
    }
  </style>
  <template>
    <catalog-data packages="{{packages}}" elements="{{elements}}"></catalog-data>
    <div class="vertical layout">
      <input id="q" placeholder="Search the Catalog" type="search" value="{{query::keyup}}">
      <div id="results" class="flex">
        <h3 hidden$="[[!anyPackages]]">Packages</h3>
        <template is="x-repeat" items="[[packageMatches]]">
          <div><div class="result" data-id="[[item.name]]" on-click="navigatePackage">
            <h4>[[item.title]]</h4>
            <p>[[item.description]]</p>
          </div></div>
        </template>

        <h3 hidden$="[[!anyElements]]">Elements</h3>
        <template is="x-repeat" items="[[elementMatches]]">
          <div class="result" data-id="[[item.name]]" on-click="navigateElement">
            <h4>{{item.name}}</h4>
            <p>[[item.description]]</p>
          </div>
        </template>
      </div>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'catalog-search',
    properties: {
      query: {
        type: String
      },
      active: {
        type: Boolean,
        value: false,
        notify: true,
        reflectToAttribute: true
      },
      packages: {
        type: Array,
        value: []
      },
      elements: {
        type: Object,
        value: {}
      },
      anyPackages: {type: Boolean, notify: true, value: false},
      anyElements: {type: Boolean, notify: true, value: false},
    },
    observers: {
      'active': 'activeChanged',
      'query':  'queryChanged'
    },
    activeChanged: function() {
      if (this.active) {
        this.$.q.focus();
      }
    },
    queryChanged: function() {
      this.packageMatches = [];
      this.elementMatches = [];
      this.anyPackages = this.anyElements = false;

      if (!this.query.length) { return; }
      var q = this.query.toLowerCase();

      for (var i = 0; i < this.packages.length; i++) {
        if (this.packages[i].name.indexOf(q) >= 0) {
          this.anyPackages = true;
          this.packageMatches.push(this.packages[i]);
        }
      }

      for (var el in this.elements) {
        if (this.elements[el].name.indexOf(q) >= 0) {
          this.anyElements = true;
          this.elementMatches.push(this.elements[el]);
        }
      }
    },
    navigatePackage: function(e) {
      e = Polymer.dom(e);
      for (var i = 0; i < e.path.length; i++) {
        console.log(e.path[i]);
        if (e.path[i].getAttribute('data-id')) { console.log(e.path[i].getAttribute('data-id')) };
      }
    },
    navigateElement: function(e) {
      console.log(Polymer.dom(e));
    }
  });
</script>